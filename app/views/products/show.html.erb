
<script type="text/javascript" src="https://js.stripe.com/v2/"></script>
  <script type="text/javascript">
    Stripe.setPublishableKey('pk_test_eEaAgIXINXVLsw2Tyonp8y9g');
    
    $(function() {
    var $form = $('#payment-form');
    $form.submit(function(event) {
      // Disable the submit button to prevent repeated clicks:
      $form.find('.submit').prop('disabled', true);
  
      // Request a token from Stripe:
      Stripe.card.createToken($form, stripeResponseHandler);
  
      // Prevent the form from being submitted:
      return false;
    });
  });
  
    function stripeResponseHandler(status, response) {
    // Grab the form:
    var $form = $('#payment-form');
  
    if (response.error) { // Problem!
  
      // Show the errors on the form:
      $form.find('.payment-errors').text(response.error.message);
      $form.find('.submit').prop('disabled', false); // Re-enable submission
  
    } else { // Token was created!
  
      // Get the token ID:
      var token = response.id;
  
      // Insert the token ID into the form so it gets submitted to the server:
      $form.append($('<input type="hidden" name="stripeToken">').val(token));
  
      // Submit the form:
      $form.get(0).submit();
    }
  };
  </script>
  
<div class="container white_pane">
  
  <div class="row grey_pane">
  
      <div class="col-md-4 product_header">
        <%= link_to gravatar_for(@product.merchant, size:75), merchant_path(@product.merchant) %>
        &nbsp;&nbsp;
        <%= @product.merchant.merchantname %>
      </div>
      
      <div class="col-md-8 text-right">
        <% @products.each do |product| %>
         <%= link_to image_tag(product.picture.url, size: "70x70", class: "image_preview"), product_path(product.id) if product.picture? %>
        <% end %> 
        
        <%= link_to @product_count.to_s + " items", merchant_path(@product.merchant), class: "merchant_items" %>
      </div>

  </div><!-- end of row -->


 
  <div class="row"> 
    <div class="col-md-7">
      <div class="show_product">
        <%= image_tag(@product.picture.url, class: "gravatar") if @product.picture? %>
      </div>
    </div><!-- end of col-md-6 -->
    
    
    <div class="col-md-5">
      <div class="well">
        
        <div class="pull-right">
          <%= link_to like_product_path(@product, like: true), method: :post do %>
            <i class="glyphicon glyphicon-thumbs-up"></i> &nbsp; <%= @product.thumbs_up_total %>
          <% end %> &nbsp;&nbsp;&nbsp;&nbsp;
          <%= link_to like_product_path(@product, like: false), method: :post do %>
            <i class="glyphicon glyphicon-thumbs-down"></i> &nbsp; <%= @product.thumbs_down_total %>
          <% end %>
        </div>
        
        <h3><%= @product.name %></h3><br>
        <h5><%= @product.summary %></h5>
        <h3><%= "€" + number_with_precision(@product.price, :precision => 2).to_s %></h3><br>
        <%= simple_format(@product.description )%><br>

        <% if @connect != nil %>
        
              
        <div class="well" >
          <form action="/pay" method="POST" id="payment-form">
          <table>
          
            <tr>
              <td align="left" colspan="3">
                <h4>Credit card details</h4>
              </td>
            </tr>
          
            <tr><td colspan="3">
                  <span class="payment-errors alert-danger">
            </td></tr>
            <tr><td colspan="2">
              <input type="text" data-stripe="number" placeholder="Card number" style="width: 150px;">
            </td><td></tr>
            <tr><td width="25%"><input type="date" style="width: 69px;" data-stripe="exp" placeholder="MM/YY">
              </td>
              <td width="25%"><input type="text" style="width: 69px;" data-stripe="cvc" placeholder="CVC">
              </td>
            </tr>
            <tr><td colspan="2">
              </td></tr>
          </table>
          <input type="hidden" name="product_id" value= "<%= @product.id.to_s %>" />
          <input type="submit" class="btn btn-success" value= " <%= "Pay €" + number_with_precision(@product.price, :precision => 2).to_s %>" >
            
        </div>


        <% else %>
          <h5>Merchant not connected to payment processor</h5>
        <% end %>
   
      </div> <!-- end of well  -->
    </div> <!-- end of col-md-6 -->
  </div> <!-- end of row -->

  <div class="row"> 
    <div class="col-md-3">
      <h5><%= link_to "Return to full Products Listing", root_path, class: "btn btn-success btn-small" %></h5>
    </div>
    
          
    <div class="col-md-9 text-left">
      <% if logged_in? and @product.merchant == current_user %>
      
      <div class="nav_item">
        <%= link_to '', edit_product_path(@product), class: "glyphicon glyphicon-wrench" %>
      </div> 
      <div class="nav_item">
        <%= link_to "",  @product, class: "glyphicon glyphicon-trash", method: :delete,data: { confirm: "You sure?" } %>
      </div>
       
      <% end %> <!-- end if -->
    </div><!-- end col-md-9 -->
  </div><!-- end row -->
</div><!-- end container -->